<div class="audio-manager">
  <div class="audio-manager__sources" role="group" aria-label="Select an audio source">
    <button type="button" class="source-card" (click)="onUrlTileClick()">
      <span class="source-card__icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
        </svg>
      </span>
      <span class="source-card__body">
        <strong>Link an audio URL</strong>
        <small>Prefetch remote audio with progress tracking.</small>
      </span>
    </button>

    <button type="button" class="source-card" (click)="onFileTileClick()">
      <span class="source-card__icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776"/>
        </svg>
      </span>
      <span class="source-card__body">
        <strong>Upload from device</strong>
        <small>Drop WAV, MP3, M4A, and more.</small>
      </span>
    </button>
    <input id="fileInput" class="sr-only" type="file" (change)="onFileSelected($event)" />

    <ng-container *ngIf="globalNavigator.mediaDevices">
      <button type="button" class="source-card" (click)="onRecordTileClick()">
        <span class="source-card__icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"/>
          </svg>
        </span>
        <span class="source-card__body">
          <strong>Record right here</strong>
          <small>Capture studio-grade snippets in-browser.</small>
        </span>
      </button>
    </ng-container>
  </div>

  <div class="audio-manager__progress" *ngIf="progress !== undefined || audioData">
    <div class="audio-manager__progress-bar">
      <div class="audio-manager__progress-fill"
           [ngStyle]="{'width': (progress ? (progress * 100) + '%' : (audioData ? '100%' : '0%'))}"></div>
    </div>
    <span class="audio-manager__progress-label">
      {{ progress !== undefined ? 'Processing audio...' : 'Ready to transcribe' }}
    </span>
  </div>

  <div class="audio-manager__player" *ngIf="audioData">
    <div class="audio-manager__player-shell">
      <audio class="audio-manager__audio" [src]="audioData.url" controls></audio>
      <div class="audio-manager__meta">
        <span class="audio-manager__badge">{{ audioData.source | lowercase }} source</span>
        <span class="audio-manager__type">{{ audioData.mimeType }}</span>
      </div>
    </div>
    <div class="audio-manager__actions">
      <button type="button" class="cta" (click)="transcriber.start(audioData.buffer)">
        Transcribe audio
      </button>
      <button type="button" class="cta cta--ghost" (click)="onSettingsTileClick()">
        Adjust settings
      </button>
    </div>
  </div>

  <div class="audio-manager__loader" *ngIf="transcriber.progressItems?.length > 0">
    <span class="audio-manager__loader-spinner" aria-hidden="true"></span>
    Loading model files... this only runs once.
  </div>

  <div class="modal" *ngIf="showUrlModal">
    <div class="modal__overlay" (click)="onUrlModalClose()"></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="url-modal-title">
      <div class="modal__header">
        <h3 id="url-modal-title">Load from URL</h3>
        <p>Paste a direct audio link to fetch and analyse.</p>
      </div>
      <label class="modal__field">
        <span>Audio URL</span>
        <input type="url" [(ngModel)]="urlInput" placeholder="https://example.com/audio.wav" required />
      </label>
      <div class="modal__actions">
        <button type="button" class="cta" (click)="onUrlModalSubmit()">Load audio</button>
        <button type="button" class="cta cta--ghost" (click)="onUrlModalClose()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="showRecordModal">
    <div class="modal__overlay" (click)="onRecordModalClose()"></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="record-modal-title">
      <div class="modal__header">
        <h3 id="record-modal-title">Record new audio</h3>
        <p>Capture a sample directly through your microphone.</p>
      </div>
      <app-audio-recorder (onRecordingComplete)="onRecordModalSubmit($event)"></app-audio-recorder>
      <div class="modal__actions modal__actions--end">
        <button type="button" class="cta cta--ghost" (click)="onRecordModalClose()">Close</button>
      </div>
    </div>
  </div>

  <div class="modal" *ngIf="showSettingsModal">
    <div class="modal__overlay" (click)="onSettingsModalClose()"></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
      <div class="modal__header">
        <h3 id="settings-modal-title">Transcription settings</h3>
        <p>Choose a Whisper model and optional multilingual mode.</p>
      </div>
      <label class="modal__field">
        <span>Model variant</span>
        <select [(ngModel)]="transcriber.model">
          <option value="Xenova/whisper-tiny">Xenova/whisper-tiny</option>
          <option value="Xenova/whisper-base">Xenova/whisper-base</option>
          <option value="Xenova/whisper-small">Xenova/whisper-small</option>
          <option value="Xenova/whisper-medium">Xenova/whisper-medium</option>
        </select>
      </label>
      <div class="modal__checkboxes">
        <label>
          <input id="multilingual" type="checkbox" [(ngModel)]="transcriber.multilingual" />
          <span>Enable multilingual decoding</span>
        </label>
        <label>
          <input id="quantize" type="checkbox" [(ngModel)]="transcriber.quantized" />
          <span>Use quantized weights</span>
        </label>
      </div>
      <div class="modal__grid" *ngIf="transcriber.multilingual">
        <label class="modal__field">
          <span>Source language</span>
          <select [(ngModel)]="transcriber.language">
            <option value="en">English</option>
            <option value="zh">Chinese</option>
            <option value="de">German</option>
          </select>
        </label>
        <label class="modal__field">
          <span>Task</span>
          <select [(ngModel)]="transcriber.subtask">
            <option value="transcribe">Transcribe</option>
            <option value="translate">Translate (to English)</option>
          </select>
        </label>
      </div>
      <div class="modal__actions">
        <button type="button" class="cta" (click)="onSettingsModalSubmit()">Save</button>
        <button type="button" class="cta cta--ghost" (click)="onSettingsModalClose()">Cancel</button>
      </div>
    </div>
  </div>
</div>
